#
# "THE BEER-WARE LICENSE" (Revision CS-42):
#
# This file was written by the CodeShop developers.  As long as you
# retain this notice you can do whatever you want with it.
# If we meet some day, and you think this file is worth it, you can
# buy us a beer in return.  Even if you do that, this file still
# comes WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#

#
# This makefile creates a Python virtual environment in the staging
# directory, initially containg recent versions of pip, setuptools,
# and wheel.  It is intended to be used as an environment providing
# these tools, and for running unit tests.
#

#
# Downstream projects must rebuild when
# $(stage-dir)/timestamps/staging_venv has been touched.
#

include usp-builder/USPCommon.mki

$(if $(work-dir),,$(error work-dir must be set))
$(if $(stage-dir),,$(error stage-dir must be set))

venv-pip := $(call to-shell,$(stage-dir)/venv/$(if $(windows),Scripts,bin)/python) -m pip $(if $(verbose),--verbose)

.PHONY: all
all:

.PHONY: stage
stage: $(stage-dir)/timestamps/staging_venv

$(stage-dir)/timestamps/staging_venv: \
  $(work-dir)/stage-stamp | $(stage-dir)/timestamps
	echo timestamp >"$(call to-shell,$@)"

$(work-dir)/stage-stamp: | $(work-dir)
	$(usp-rm-rf) "$(call to-shell,$(stage-dir)/venv)"
	$(usp-python) -m venv "$(call to-native,$(stage-dir)/venv)"
	cd "$(call to-shell,$(work-dir))" && \
	  $(venv-pip) install --no-cache --progress-bar off \
	  --upgrade \
	  pip setuptools wheel
	echo timestamp >"$(call to-shell,$@)"

$(work-dir) $(stage-dir)/timestamps:
	$(usp-mkdir-p) "$(call to-shell,$@)"
