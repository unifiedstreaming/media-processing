#
# Copyright (C) 2023 CodeShop B.V.
#
# This file is part of the usp-builder project.
#
# The usp-builder project is free software: you can redistribute it
# and/or modify it under the terms of version 2 of the GNU General
# Public License as published by the Free Software Foundation.
#
# The usp-builder project is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See version
# 2 of the GNU General Public License for more details.
#
# You should have received a copy of version 2 of the GNU General
# Public License along with the usp-builder project.  If not, see
# <http://www.gnu.org/licenses/>.
#

#
# This makefile creates a Python virtual environment in the staging
# directory, initially containg recent versions of pip, setuptools,
# and wheel.  It is intended to be used as an environment providing
# these tools, and for running unit tests.
#

#
# Downstream projects must rebuild when
# $(stage-dir)/timestamps/staging_venv has been touched.
#

include usp-builder/USPVenv.mki

$(if $(work-dir),,$(error work-dir must be set))

.PHONY: all
all:

.PHONY: stage
stage: $(stage-dir)/timestamps/staging_venv

$(stage-dir)/timestamps/staging_venv: | $(work-dir)
	$(usp-rm-rf) "$(call to-shell,$(venv-dir))"
	$(usp-system-python) -m venv "$(call to-native,$(venv-dir))"
	cd "$(call to-shell,$(work-dir))" && $(venv-pip) \
	  install --no-cache --progress-bar off --upgrade \
	  pip setuptools wheel
	echo timestamp >"$(call to-shell,$@)"

$(work-dir):
	$(usp-mkdir-p) "$(call to-shell,$@)"
