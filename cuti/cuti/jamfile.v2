#
# Copyright (C) 2021 CodeShop B.V.
#
# This file is part of the cuti library.
#
# The cuti library is free software: you can redistribute it and/or
# modify it under the terms of version 2.1 of the GNU Lesser General
# Public License as published by the Free Software Foundation.
#
# The cuti library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See version
# 2.1 of the GNU Lesser General Public License for more details.
#
# You should have received a copy of version 2.1 of the GNU Lesser
# General Public License along with the cuti library.  If not, see
# <http://www.gnu.org/licenses/>.
#

import os ;

if [ os.name ] = NT
{
  lib advapi32 ;
  lib ws2_32 ;
}
else
{
  alias advapi32 : ;
  alias ws2_32 : ;
}

constant CUTI_VERSION_SUFFIX : _0_0_0 ;

rule cuti-dll-name ( name : type ? : properties * )
{
  if $(type) != SHARED_LIB
  {
    return "" ;
  }

  local prefix ;
  local extension ;
  if [ os.name ] = NT
  {
    prefix = "" ;
    extension = ".dll" ;
  }
  else if [ os.name ] = MACOSX
  {
    prefix = "" ;
    extension = ".dylib" ;
  }
  else
  {
    prefix = "lib" ;
    extension = ".so" ;
  }

  local result = "$(prefix)$(name)$(CUTI_VERSION_SUFFIX)$(extension)" ;
# echo "cuti-dll-name: mapped $(name) to $(result)" ;
  return $(result) ;
}

lib cuti
:
  args_reader.cpp
  async_readers.cpp
  async_writers.cpp
  bound_inbuf.cpp
  bound_outbuf.cpp
  callback.cpp
  cancellation_ticket.cpp
  charclass.cpp
  chrono_types.cpp
  circular_buffer.cpp
  client.cpp
  clock_object.cpp
  cmdline_reader.cpp
  config_file_reader.cpp
  default_backend.cpp
  default_scheduler.cpp
  dispatcher.cpp
  endpoint.cpp
  eof_reader.cpp
  epoll_selector.cpp
  exception_builder.cpp
  file_backend.cpp
  final_result.cpp
  flag.cpp
  flusher.cpp
  fs_utils.cpp
  format.cpp
  identifier.cpp
  indexed_heap.cpp
  kqueue_selector.cpp
  linkage.cpp
  list_arena.cpp
  listener.cpp
  logger.cpp
  logging_backend.cpp
  logging_context.cpp
  loglevel.cpp
  membuf.cpp
  nb_inbuf.cpp
  nb_outbuf.cpp
  nb_sink.cpp
  nb_source.cpp
  nb_string_inbuf.cpp
  nb_string_outbuf.cpp
  nb_tcp_buffers.cpp
  nb_tickets_holder.cpp
  option_walker.cpp
  parse_error.cpp
  poll_selector.cpp
  process.cpp
  quoted_string.cpp
  reader_traits.cpp
  reader_utils.cpp
  relational_ops.cpp
  resolver.cpp
  result.cpp
  scheduler.cpp
  scoped_guard.cpp
  scoped_thread.cpp
  select_selector.cpp
  selector.cpp
  selector_factory.cpp
  service.cpp
  signal_handler.cpp
  socket_nifty.cpp
  stack_marker.cpp
  streambuf_backend.cpp
  subresult.cpp
  subroutine.cpp
  syslog_backend.cpp
  system_error.cpp
  tcp_acceptor.cpp
  tcp_connection.cpp
  tcp_socket.cpp
  throughput_checker.cpp
  viewbuf.cpp
  writer_traits.cpp
  writer_utils.cpp
  advapi32
  ws2_32
:
  <toolset>msvc:<cxxflags>/wd4251 # class needs to have dll-interface 
  <toolset>msvc:<cxxflags>/wd4275 # non dll-interface class used as base
  <toolset>msvc:<cxxflags>/wd4910 # dllexport on extern template
# <toolset>msvc:<cxxflags>/bigobj
  <define>BUILDING_CUTI
  <link>shared
  <target-os>linux:<linkflags>-Wl,--enable-new-dtags
  <tag>@cuti-dll-name
  <target-os>windows:<define>NOMINMAX
  <target-os>windows:<define>WIN32_LEAN_AND_MEAN
  <threading>multi
  <visibility>hidden
:
:
  <toolset>msvc:<cxxflags>/wd4251 # class needs to have dll-interface 
  <toolset>msvc:<cxxflags>/wd4275 # non dll-interface class used as base
  <toolset>msvc:<cxxflags>/bigobj
  <include>..
; 
