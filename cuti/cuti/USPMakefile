#
# Copyright (C) 2022 CodeShop B.V.
#
# This file is part of the cuti library.
#
# The cuti library is free software: you can redistribute it and/or
# modify it under the terms of version 2.1 of the GNU Lesser General
# Public License as published by the Free Software Foundation.
#
# The cuti library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See version
# 2.1 of the GNU Lesser General Public License for more details.
#
# You should have received a copy of version 2.1 of the GNU Lesser
# General Public License along with the cuti library.  If not, see
# <http://www.gnu.org/licenses/>.
#

src-dir := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))

include $(src-dir)/../../include/USPCommon.mki

sources := $(call find-files,%,$(src-dir))
work-dir := $(call project-work-dir,cuti)

.PHONY: all
all: $(work-dir)/build-stamp

$(work-dir)/build-stamp: $(sources) | $(work-dir)
	$(info generating $@.dep)
	$(file >$@.dep,$(call dependency-listing,$@,$(sources)))
	$(bjam) $(bjam-options) $(build-settings) "$(call to-native,$(src-dir))"
	echo timestamp >"$(call to-shell,$@)"

$(work-dir):
	$(mkdir) "$(call to-shell,$@)"

-include $(work-dir)/build-stamp.dep

.PHONY: stage
stage: $(stage-dir)/lib/jamfiles/cuti/jamfile

$(stage-dir)/lib/jamfiles/cuti/jamfile: $(work-dir)/bjam-stage-stamp $(stage-dir)/lib/jamfiles/Jamroot | $(stage-dir)/lib/jamfiles/cuti
	$(info generating $@)
	$(file >$@,$(call staged-jamfile-content,cuti,$(stage-dir)/lib/$(if $(windows),,lib)cuti_0_0_0$(if $(windows),.lib,.so),$(abspath $(src-dir)/..)))

$(work-dir)/bjam-stage-stamp: $(work-dir)/build-stamp
	$(bjam) $(bjam-options) $(build-settings) "$(call to-native,$(src-dir))//stage"
	echo timestamp >"$(call to-shell,$@)"
	
$(stage-dir)/lib/jamfiles/cuti:
	$(mkdir) "$(call to-shell,$@)"
	
.PHONY: clean
clean:
	$(rmdir) "$(call to-shell,$(work-dir))"
	$(bjam) --clean $(bjam-options) $(build-settings) "$(call to-native,$(src-dir))"
