#
# "THE BEER-WARE LICENSE" (Revision CS-42):
#
# This file was written by the CodeShop developers.  As long as you
# retain this notice you can do whatever you want with it.
# If we meet some day, and you think this file is worth it, you can
# buy us a beer in return.  Even if you do that, this file still
# comes WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#

src-dir := $(abspath $(dir $(lastword $(MAKEFILE_LIST))))

include USPCommon.mki

$(if $(unix-like),,$(error unix-like build environment required))

$(if $(build-dir),,$(error build-dir must be set))
$(call check-out-of-tree,$(build-dir),$(src-dir))
override build-dir := $(abspath $(build-dir))

$(if $(install-dir),,$(error install-dir must be set))
$(call check-out-of-tree,$(install-dir),$(src-dir))
override install-dir := $(abspath $(install-dir))

using-cl := $(if $(windows),CC=cl.exe)
extra-cflags := $(if $(using-cl),$(if $(debug-build),-MDd,-MD -Z7),$(if $(debug-build),,-g))

configure-options := \
  --prefix=$(install-dir) \
  $(if $(debug-build),--enable-debug) \
  $(if $(extra-cflags),--extra-cflags="$(extra-cflags)") \
  --disable-cli \
  --enable-static \
  --enable-pic \
  --disable-opencl \
  --disable-avs \
  --disable-swscale \
  --disable-lavf \
  --disable-ffms \
  --disable-gpac \
  --disable-lsmash
  
sources := $(call find-files,%,$(src-dir))

.PHONY: all
all: $(build-dir)/build-stamp

.PHONY: install
install: $(build-dir)/install-stamp

.PHONY: clean
clean :
	rm -rf $(build-dir)

$(build-dir)/build-stamp: $(build-dir)/config.mak $(sources)
	$(file >$@.dep,$(call dependency-listing,$@,$(sources)))
	$(MAKE) -C $(build-dir)
	echo timestamp >$@

$(build-dir)/install-stamp: $(build-dir)/build-stamp
	$(MAKE) -C $(build-dir) install
	echo timestamp >$@

#
# libx264's configure script generates a symlink for the Makefile in
# the build directory; the actual configuration is recorded in
# config.mak.
#
$(build-dir)/config.mak: \
  $(addprefix $(src-dir)/,configure config.guess config.sub) \
  | $(build-dir)
	cd $(build-dir) && $(using-cl) $(src-dir)/configure $(configure-options)

$(build-dir):
	mkdir -p $@
  
-include $(build-dir)/build-stamp.dep
