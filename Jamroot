#
# "THE BEER-WARE LICENSE" (Revision CS-42):
#
# This file was written by the CodeShop developers.  As long as you
# retain this notice you can do whatever you want with it.
# If we meet some day, and you think this file is worth it, you can
# buy us a beer in return.  Even if you do that, this file still
# comes WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#

import os ;
import errors ;
import regex ;

rule require-from-environ ( name )
{
  local value = [ os.environ $(name) ] ;
  if $(value) = ""
  {
    errors.error "no value for '$(name)' found in environment" ;
  }
  return $(value) ;
}

path-constant stage-dir : [ require-from-environ stage-dir ] ;

project oss
: requirements
  <cxxstd>17
  <debug-symbols>on
  <toolset>msvc:<cxxflags>/wd4251 # class needs to have dll-interface
  <toolset>msvc:<cxxflags>/wd4275 # non dll-interface class used as base
  <toolset>msvc:<cxxflags>/wd4910 # dllexport on extern template
  <target-os>windows:<define>NOMINMAX
  <target-os>windows:<define>WIN32_LEAN_AND_MEAN
  <threading>multi
  <target-os>linux:<linkflags>-Wl,--enable-new-dtags
  <target-os>linux:<linkflags>-Wl,-rpath,\\$ORIGIN/../lib
  <local-visibility>hidden
: default-build
# <variant>release
  <address-model>64
;

rule dll-subdir ( parent-dir )
{
  local subdir = lib ;
  if [ os.name ] = NT
  {
    subdir = bin ;
  }
  return $(parent-dir)/$(subdir) ;
}

rule stage-dll-dir ( )
{
  local stage-dir = [ require-from-environ stage-dir ] ;
  return [ dll-subdir $(stage-dir) ] ;
}

rule stage-implib-dir ( )
{
  local stage-dir = [ require-from-environ stage-dir ] ;
  return $(stage-dir)/lib ;
}

rule deploy-dll-dir ( )
{
  local dest-dir = [ require-from-environ dest-dir ] ;
  return [ dll-subdir $(dest-dir) ] ;
}

rule deploy-exe-dir ( )
{
  local dest-dir = [ require-from-environ dest-dir ] ;
  return $(dest-dir)/bin ;
}

rule stage-dll-location ( properties * )
{
  local dir = [ stage-dll-dir ] ;
  return <location>$(dir) ;
}

rule stage-implib-location ( properties * )
{
  local dir = [ stage-implib-dir ] ;
  return <location>$(dir) ;
}

rule deploy-dll-location ( properties * )
{
  local dir = [ deploy-dll-dir ] ;
  return <location>$(dir) ;
}

rule deploy-exe-location ( properties * )
{
  local dir = [ deploy-exe-dir ] ;
  return <location>$(dir) ;
}

rule version-suffix ( version ? )
{
  local result = "" ;
  if $(version) != ""
  {
    version = [ regex.replace $(version) \\. _ ] ;
    result = _$(version) ;
  }
  return $(result) ;
}

rule dll-artifact-name ( name : version ? : type ? )
{
  local osname = [ os.name ] ; 

  local prefix = "" ;
  local extension = "" ;

  if $(osname) = NT
  {
    if $(type) = SHARED_LIB
    {
      extension = ".dll" ;
    }
    else if $(type) = PDB
    {
      extension = ".pdb" ;
    }
  }
  else if $(osname) = MACOSX
  {
    if $(type) = SHARED_LIB
    {
      prefix = "lib" ;
      extension = ".dylib" ;
    }
  }
  else
  {
    if $(type) = SHARED_LIB
    {
      prefix = "lib" ;
      extension = ".so" ;
    }
  }

  local result = "" ;
  if $(extension) != "" 
  {
    local vsuffix = [ version-suffix $(version) ] ;
    result = $(prefix)$(name)$(vsuffix)$(extension) ;
  }

  return $(result) ;
}

